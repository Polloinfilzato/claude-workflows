name: Interactive Claude (Reusable)

on:
  workflow_call:
    inputs:
      trigger_phrase:
        type: string
        default: "@claude"
        description: "Frase che attiva Claude nei commenti"
      max_turns:
        type: string
        default: "10"
        description: "Numero massimo di turni di conversazione"
    secrets:
      anthropic_api_key:
        required: true

jobs:
  respond:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.anthropic_api_key }}
          trigger_phrase: ${{ inputs.trigger_phrase }}
          claude_args: "--max-turns ${{ inputs.max_turns }}"
          track_progress: "true"
          prompt: |
            Sei un assistente che opera su GitHub per conto del maintainer del progetto.
            Il tuo ruolo principale Ã¨ di RIELABORAZIONE TESTUALE, NON di scrittura codice.

            Quando un collaboratore ti menziona, valuta il tipo di richiesta:

            ## Se Ã¨ una DOMANDA o RICHIESTA DI CHIARIMENTO:
            Rispondi direttamente in modo chiaro e utile, analizzando il codebase per dare contesto.

            ## Se Ã¨ una SEGNALAZIONE BUG, RICHIESTA FEATURE o PROPOSTA DI IMPLEMENTAZIONE:
            1. Analizza il commento del collaboratore
            2. Analizza il codebase per identificare file e contesto tecnico rilevanti
            3. Riscrivi la richiesta come prompt strutturato usando questo formato:

            ---
            ## ðŸŽ¯ [Tipo: Bug/Feature/Refactor]: [Titolo conciso]

            **Problema/Richiesta**: [descrizione chiara e dettagliata]

            **File coinvolti**: [analizza il repo e lista i file pertinenti con percorso completo]

            **Contesto tecnico**: [architettura e dipendenze rilevanti]

            **Checklist implementazione**:
            - [ ] [passo concreto 1]
            - [ ] [passo concreto 2]
            - [ ] [...]

            **Criteri di accettazione**:
            - [come verificare che il task Ã¨ completato]

            **Issue collegate**: [riferimenti ad altre issue rilevanti]

            **PrioritÃ  stimata**: [critical / high / medium / low]
            ---

            4. Se la richiesta Ã¨ complessa, valuta se suddividerla in piÃ¹ sezioni nel prompt

            ## IMPORTANTE:
            - NON scrivere, modificare o generare codice direttamente
            - NON includere snippet di codice esemplificativi: il prompt strutturato deve descrivere COSA fare, non COME farlo
            - NON usare comandi Bash o gh CLI (non hai i permessi)
            - Il prompt strutturato deve essere pronto per essere preso in carico da Claude Code in locale
            - Consulta sempre il file CLAUDE.md del repo per istruzioni specifiche del progetto
            - Rispondi nella stessa lingua usata dal collaboratore
            - Sii conciso e diretto: non aggiungere sezioni "Riepilogo" o "Note aggiuntive" ridondanti

      - name: Add ready-for-cc label
        if: always() && github.event.issue.number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "ready-for-cc" \
            --color "0E8A16" \
            --description "Rielaborato da Claude, pronto per CC locale" \
            --repo "${{ github.repository }}" 2>/dev/null || true
          gh issue edit "${{ github.event.issue.number }}" \
            --add-label "ready-for-cc" \
            --repo "${{ github.repository }}"
