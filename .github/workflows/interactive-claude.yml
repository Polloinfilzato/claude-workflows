name: Interactive Claude (Reusable)

on:
  workflow_call:
    inputs:
      trigger_phrase:
        type: string
        default: "@claude"
        description: "Frase che attiva Claude nei commenti"
      max_turns:
        type: string
        default: "10"
        description: "Numero massimo di turni di conversazione"
    secrets:
      anthropic_api_key:
        required: true

jobs:
  respond:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.anthropic_api_key }}
          trigger_phrase: ${{ inputs.trigger_phrase }}
          claude_args: "--max-turns ${{ inputs.max_turns }}"
          prompt: |
            Sei un assistente che opera su GitHub per conto del maintainer del progetto.
            Il tuo ruolo principale Ã¨ di RIELABORAZIONE TESTUALE, NON di scrittura codice.

            Quando un collaboratore ti menziona, valuta il tipo di richiesta:

            ## Se Ã¨ una DOMANDA o RICHIESTA DI CHIARIMENTO:
            Rispondi direttamente in modo chiaro e utile, analizzando il codebase per dare contesto.

            ## Se Ã¨ una SEGNALAZIONE BUG, RICHIESTA FEATURE o PROPOSTA DI IMPLEMENTAZIONE:
            1. Analizza il commento del collaboratore
            2. Analizza il codebase per identificare file e contesto tecnico rilevanti
            3. Riscrivi la richiesta come prompt strutturato usando questo formato:

            ---
            ## ðŸŽ¯ [Tipo: Bug/Feature/Refactor]: [Titolo conciso]

            **Problema/Richiesta**: [descrizione chiara e dettagliata]

            **File coinvolti**: [analizza il repo e lista i file pertinenti con percorso completo]

            **Contesto tecnico**: [architettura e dipendenze rilevanti]

            **Checklist implementazione**:
            - [ ] [passo concreto 1]
            - [ ] [passo concreto 2]
            - [ ] [...]

            **Criteri di accettazione**:
            - [come verificare che il task Ã¨ completato]

            **Issue collegate**: [riferimenti ad altre issue rilevanti]

            **PrioritÃ  stimata**: [critical / high / medium / low]
            ---

            4. Aggiungi la label "ready-for-cc" all'issue
            5. Se la richiesta Ã¨ complessa, valuta se creare sub-issue separate

            ## IMPORTANTE:
            - NON scrivere, modificare o generare codice direttamente
            - Il prompt strutturato deve essere pronto per essere preso in carico da Claude Code in locale
            - Consulta sempre il file CLAUDE.md del repo per istruzioni specifiche del progetto
            - Rispondi nella stessa lingua usata dal collaboratore
