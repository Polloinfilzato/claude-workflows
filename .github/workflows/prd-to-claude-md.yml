name: PRD to CLAUDE.md (Reusable)

on:
  workflow_call:
    secrets:
      anthropic_api_key:
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Generate CLAUDE.md from PRDs
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          PROMPT=$(cat <<'ENDPROMPT'
          Analizza i file PRD (Product Requirements Document) nella cartella .claude/prds/
          e il codebase esistente del repository.

          Il tuo compito è generare o aggiornare il file CLAUDE.md nella root del repository
          con le istruzioni specifiche del progetto.

          ## ANALISI DA EFFETTUARE:
          1. Leggi TUTTI i file .md in .claude/prds/
          2. Analizza il codebase: struttura cartelle, tecnologie, pattern usati
          3. Identifica lo stack tecnologico dai file di configurazione (package.json, requirements.txt, Cargo.toml, ecc.)
          4. Rileva convenzioni di naming e struttura già presenti nel codice

          ## STRUTTURA DEL CLAUDE.md DA GENERARE:

          # Istruzioni Specifiche Progetto

          ## Panoramica
          [Breve descrizione del progetto basata sui PRD]

          ## Stack Tecnologico
          [Lista tecnologie rilevate dal codebase e dai PRD]

          ## Struttura Progetto
          [Mappa delle cartelle principali con descrizione]

          ## Convenzioni
          [Naming, stile, pattern rilevati o specificati nei PRD]

          ## Dipendenze Chiave
          [Librerie e framework principali con versione]

          ## Istruzioni per @claude su GitHub
          (Queste integrano le regole globali dell utente)
          - Quando rielabori prompt, considera lo stack e la struttura sopra indicati
          - Riferisci sempre i file con percorso completo dalla root
          - Nelle checklist, includi passi di testing appropriati per lo stack del progetto

          ## Manutenzione Documentazione
          Quando CC (Claude Code) in locale apporta modifiche sostanziali al progetto
          (nuova funzione, rimozione funzione, refactoring significativo, nuova dipendenza),
          DEVE aggiornare la documentazione seguendo queste regole:

          ### README.md
          - Mantenere aggiornata la descrizione delle funzionalita principali
          - Aggiornare le istruzioni di installazione se cambiano dipendenze
          - Aggiornare gli esempi d uso se cambia l interfaccia/API
          - Aggiornare la sezione Struttura Progetto se cambiano cartelle rilevanti

          ### CHANGELOG.md
          Usare il formato Keep a Changelog (https://keepachangelog.com/):
          - Ogni modifica va sotto la versione corrente [Unreleased]
          - Categorie: Added, Changed, Deprecated, Removed, Fixed, Security
          - Includere la data quando si rilascia una versione
          - Numerazione sequenziale Semantic Versioning (MAJOR.MINOR.PATCH)
          - Se il file non esiste, crearlo con il template standard

          ### Cartella /docs/
          - Se il progetto ha una cartella /docs/, aggiornare i file pertinenti
          - Creare nuovi file in /docs/ per funzionalita complesse che meritano documentazione dedicata
          - Naming: kebab-case.md (es. authentication-flow.md, api-endpoints.md)
          - Ogni file in /docs/ deve avere un titolo H1 e una breve introduzione
          - Se /docs/ non esiste e il progetto lo richiede, crearla con un file index.md

          ### Regola Generale
          La documentazione va aggiornata NELLO STESSO COMMIT della modifica al codice,
          non in commit separati. Questo garantisce che codice e docs siano sempre sincronizzati.

          ## Note Aggiuntive
          [Qualsiasi altra informazione utile estratta dai PRD]

          ## REGOLE IMPORTANTI:
          - Se CLAUDE.md esiste gia, PRESERVA qualsiasi contenuto aggiunto manualmente dall utente
          - Aggiungi un commento HTML in cima: Generato automaticamente da PRD con la data
          - Se non riesci a determinare qualcosa con certezza, omettilo piuttosto che inventare
          - Basa le informazioni SOLO su quello che trovi nei PRD e nel codebase reale
          - Fai commit delle modifiche con messaggio: "chore: aggiorna CLAUDE.md da PRD"
          ENDPROMPT
          )

          echo "$PROMPT" | npx -y @anthropic-ai/claude-code@latest -p \
            --max-turns 15 \
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git add *),Bash(git commit *),Bash(git status *),Bash(git diff *)"

      - name: Push changes
        run: |
          git diff --quiet HEAD origin/$(git branch --show-current) 2>/dev/null || git push
